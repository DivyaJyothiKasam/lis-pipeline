#!/usr/bin/env groovy

def PowerShellWrapper(psCmd) {
    psCmd = psCmd.replaceAll("\r", "").replaceAll("\n", "")
    bat "powershell.exe -NonInteractive -ExecutionPolicy Bypass -Command \"\$ErrorActionPreference='Stop';[Console]::OutputEncoding=[System.Text.Encoding]::UTF8;$psCmd;EXIT \$global:LastExitCode\""
}

properties ([
    [$class: 'ParametersDefinitionProperty',
        parameterDefinitions: [
        [$class: 'ChoiceParameterDefinition',
            choices: 'git://git.kernel.org/pub/scm/linux/kernel/git/next/linux-next.git\nhttps://git.kernel.org/pub/scm/linux/kernel/git/davem/net-next.git\nazure_kernel',
            name: 'KERNEL_GIT_URL',
            description: 'Linux kernel repository'],
        [$class: 'StringParameterDefinition',
            name: 'KERNEL_GIT_BRANCH',
            defaultValue: 'master',
            description: 'Kernel repo branch name'],
        [$class: 'StringParameterDefinition',
            name: 'KERNEL_GIT_COMMIT_ID',
            defaultValue: 'HEAD',
            description: 'Kernel repo commit id'],
        [$class: 'ChoiceParameterDefinition',
            choices: 'Ubuntu\nCentOS',
            name: 'DISTRO_VERSION',
            description: 'Distro version'],
        [$class: 'ChoiceParameterDefinition',
            choices: 'TCP\nUDP\nFIO',
            name: 'PERF_TEST',
            description: 'Which perf test to run'],
        [$class: 'ChoiceParameterDefinition',
            choices: 'v4\nv6',
            name: 'PERF_IPV',
            description: '[TCP] [UDP] IP version to use if the net perf test is enabled'],
        [$class: 'ChoiceParameterDefinition',
            choices: '1k\n8k',
            name: 'PERF_K',
            description: '[UDP] K to be used.'],
        [$class: 'ChoiceParameterDefinition',
            choices: '1\n2\n4\n8\n16\n32\n64\n128\n256\n512\n1024\n2048\n4096\n6144\n8192\n10240',
            name: 'PERF_TEST_THREADS_TCP',
            description: '[TCP] TEST_THREADS'],
        [$class: 'ChoiceParameterDefinition',
            choices: '1\n2\n4\n8\n16\n32\n64\n128\n256\n512\n1024',
            name: 'PERF_TEST_THREADS_UDP',
            description: '[UDP] TEST_THREADS'],
        [$class: 'ChoiceParameterDefinition',
            choices: '1\n1024',
            name: 'PERF_IO_SIZE',
            description: '[FIO] IO_SIZE'],
        [$class: 'ChoiceParameterDefinition',
            choices: '1\n2\n4\n8\n16\n32\n64\n128\n256',
            name: 'PERF_Q_DEPTH',
            description: '[FIO] Queue depth.'],
        [$class: 'ChoiceParameterDefinition',
            choices: 'read\nrandread\nwrite\nrandwrite',
            name: 'PERF_IO_MODE',
            description: '[FIO] IO_MODE'],
        [$class: 'StringParameterDefinition',
            name: 'ENABLED_STAGES',
            defaultValue: 'build_artifacts, boot_test, perf_hyperv',
            description: 'What stages to run. By default all stages are enabled']
        ]
    ]
])

UBUNTU_VERSION = '16'
BUILD_PATH = '/mnt/tmp/bisect-kernel-build-folder'
KERNEL_ARTIFACTS_PATH = 'bisect-kernel-artifacts'
KERNEL_CONFIG = 'Microsoft/config-azure'
AZURE_MAX_RETRIES = '10'
BUILD_NAME = 'b'
INSTALL_DEPS = 'True'
USE_KERNEL_FOLDER_PREFIX = 'True'
THREAD_NUMBER = 'x3'
perfXml = ["TCP": "TCP_SRIOV_v4.xml", "UDP":"UDP_SRIOV_v4.xml", "FIO": "FIO_RAID0_Pipeline.xml"]
isPerf = ENABLED_STAGES.contains('perf')
isBootTest = ENABLED_STAGES.contains('boot')
perfServer = GetPerfServer(PERF_TEST)
ioMode = GetKeyForFIO(PERF_IO_MODE)
env.DISTRO_VERSION = DISTRO_VERSION
env.KERNEL_GIT_URL = KERNEL_GIT_URL

// this is the main logic
build_kernel(DISTRO_VERSION)

if (isBootTest) {
    node ('meta_slave') {
        boot_test()
    }
}

if (isPerf) {
    node (perfServer) {
        perf()
    }
    node ('meta_slave') {
        parse_perf_data()
    }
}

def GetPerfServer(xmlName) {
    switch(xmlName) {
        case "TCP":
            return "net_perf"
        case "UDP":
            return "net_perf"
        case "FIO":
            return "stor_perf"
        default:
            currentBuild.result = 'FAILURE'
    }
}

def GetKeyForFIO(ioMode) {
     switch(ioMode) {
        case "read":
            return "seq-read:"
        case "randread":
            return "rand-read:"
        case "write":
            return "seq-write:"
        case "randwrite":
            return "rand-write:"
        default:
            currentBuild.result = 'FAILURE'
    }
}

def getPerfOptions(perf_test) {
    switch (perf_test) {
        case "TCP":
            return PERF_IPV + ";TEST_THREADS=" + PERF_TEST_THREADS_TCP
        case "UDP":
            return PERF_IPV + ";" + PERF_K + ";IPERF3_TEST_CONNECTION_POOL=" + PERF_TEST_THREADS_UDP
        case "FIO":
            return "Q_DEPTH=" + PERF_Q_DEPTH + ";IO_SIZE=" + PERF_IO_SIZE + ";IO_MODE=" + PERF_IO_MODE
    }
}

def getDistro(String distro) {
    switch (distro) {
        case "Ubuntu":
            return ["ubuntu_kernel_builder", "deb"]
        case "CentOS":
            return ["centos_kernel_builder", "rpm"]

    }
}

def build_kernel(String distro) {
    (slave, pkg) = getDistro(distro)
    println "NODE IS " + slave
    println "PKG IS " + slave
    node (slave) {
        checkout scm
        stage('build_artifacts_' + distro.toLowerCase()) {
            withCredentials(bindings: [string(credentialsId: 'MSFT_KERNEL_GIT_URL', variable: 'MSFT_KERNEL_GIT_URL')]) {
                sh '''#!/bin/bash
                    set -xe
                    if [[ "$KERNEL_GIT_URL" == "azure_kernel" ]]; then
                            KERNEL_GIT_URL=${MSFT_KERNEL_GIT_URL}
                    fi
                    echo "Building artifacts..."
                    pushd "$WORKSPACE/scripts/package_building_bisect"
                    bash build_artifacts_bisect.sh \\
                        --git_url "$KERNEL_GIT_URL" \\
                        --git_branch "$KERNEL_GIT_BRANCH" \\
                        --git_commit_id "$KERNEL_GIT_COMMIT_ID" \\
                        --destination_path "$BUILD_NUMBER-$BRANCH_NAME" \\
                        --build_path "$BUILD_PATH"
                    popd
                    '''
                    sh '''#!/bin/bash
                        echo $BUILD_NUMBER-$(crudini --get scripts/package_building/kernel_versions.ini KERNEL_BUILT folder) > ./build_name
                       '''
            currentBuild.displayName = readFile "./build_name"
            stash includes: ("scripts/package_building_bisect/$BUILD_NUMBER-$BRANCH_NAME/**/$pkg/**"),
                        name: "kernel_artifacts"
            stash includes: 'scripts/package_building/kernel_versions.ini', name: 'kernel_version_ini'
            sh """
                    set -xe
                    rm -rf "scripts/package_building_bisect/$BUILD_NUMBER-$BRANCH_NAME"
            """
            }
        }
    }
}

def boot_test() {
    node ('meta_slave') {
        stage('boot_test') {
            checkout scm
            dir(BUILD_NUMBER + BRANCH_NAME) {
                unstash "kernel_artifacts"
            }
            dir('kernel_version' + BUILD_NUMBER + BRANCH_NAME) {
                unstash 'kernel_version_ini'
                sh 'cat scripts/package_building/kernel_versions.ini'
            }
            withCredentials(bindings: [string(credentialsId: 'SMB_SHARE_URL', variable: 'SMB_SHARE_URL'),
                                              usernamePassword(credentialsId: 'smb_share_user_pass', passwordVariable: 'PASSWORD', usernameVariable: 'USERNAME')
                                      ]) {
                sh(script: '''#!/bin/bash
                              set -xe
                              distro_version=$DISTRO_VERSION
                              OS_TYPE=${distro_version%_*}
                              OS_TYPE=${OS_TYPE,,}
                              if [[ $OS_TYPE == "ubuntu" ]]; then
                                  PACKAGE_NAME="deb"
                              elif [[ $OS_TYPE == "centos" ]]; then
                                  PACKAGE_NAME="rpm"
                              fi
                              pushd $BUILD_NUMBER$BRANCH_NAME
                              mkdir -p "$PACKAGE_NAME"
                              art=$(find . -name "*.$PACKAGE_NAME")
                              mv $art "$PACKAGE_NAME"
                              popd
                              '''
                )
                exitStatus = sh(script: '''#!/bin/bash
                                       distro_version=$DISTRO_VERSION
                                       OS_TYPE=${distro_version%_*}
                                       OS_TYPE=${OS_TYPE,,}
                                       local_path=$(readlink -f ${BUILD_NUMBER}${BRANCH_NAME})
                                       AZURE_MAX_RETRIES=$AZURE_MAX_RETRIES bash scripts/azure_kernel_validation/validate_azure_vm_boot.sh \
                                               --build_name $BUILD_NAME --build_number "${BUILD_NUMBER}${BRANCH_NAME}" \
                                               --smb_share_username $USERNAME --smb_share_password $PASSWORD \
                                               --smb_share_url $SMB_SHARE_URL --os_type $OS_TYPE --vm_user_name $OS_TYPE \
                                               --local_path $local_path
                                       ''',
                                 returnStatus:true
                             )
            }
        }

        println "Cleaning Azure resources up..."
        sh(script: """#!/bin/bash
                      pushd ./scripts/azure_kernel_validation
                      bash remove_azure_vm_resources.sh "${BUILD_NAME}${BUILD_NUMBER}${BRANCH_NAME}"
                      popd
                      """
        )

        archiveArtifacts(artifacts: "$BUILD_NAME$BUILD_NUMBER$BRANCH_NAME-boot-diagnostics/*.log", allowEmptyArchive: true)
        if (exitStatus == 0) {
            nunit(testResultsPattern: 'scripts/azure_kernel_validation/tests.xml', failIfNoResults: false)
        } else {
            nunit(testResultsPattern: 'scripts/azure_kernel_validation/tests-fail.xml', failIfNoResults: false)
            sh(script: "exit 1")
        }
    }
}

def perf() {
    PERF_OPTIONS = getPerfOptions(PERF_TEST)
    XML = perfXml[PERF_TEST]
    stage('validation_perf_hyperv') {
        checkout scm
        withCredentials(bindings: [string(credentialsId: 'LISA_IMAGES_SHARE_URL', variable: 'LISA_IMAGES_SHARE_URL'),
                                   string(credentialsId: 'LISA_TEST_DEPENDENCIES', variable: 'LISA_TEST_DEPENDENCIES')]) {
            println 'Running LISA...'
            unstash 'kernel_artifacts'
            try {
                PowerShellWrapper("""
                    & .\\scripts\\lis_hyperv_platform\\main_perf.ps1
                        -JobId $BUILD_NAME$BUILD_NUMBER$BRANCH_NAME
                        -InstanceName $BUILD_NAME$BUILD_NUMBER$BRANCH_NAME
                        -VHDType $DISTRO_VERSION -WorkingDirectory C:\\workspace
                        -OSVersion 7.4
                        -LISAImagesShareUrl $LISA_IMAGES_SHARE_URL
                        -XmlTest $XML
                        -LisaTestDependencies $LISA_TEST_DEPENDENCIES
                        -LocalKernelFolder "scripts/package_building_bisect/$BUILD_NUMBER-$BRANCH_NAME/**/rpm"
                        -LisaPerfOptions '${PERF_OPTIONS}'
                    """)
                println 'Finished running LISA.'
            } catch (Exception e){
                println "LISA failed"
                currentBuild.result = 'FAILURE'
            } finally {
                println "$BUILD_NAME$BUILD_NUMBER$BRANCH_NAME\\lis-test\\WS2012R2\\lisa\\TestResults\\**\\*"
                archiveArtifacts "$BUILD_NAME$BUILD_NUMBER$BRANCH_NAME\\lis-test\\WS2012R2\\lisa\\TestResults\\**\\*"
                stash includes: "$BUILD_NAME$BUILD_NUMBER$BRANCH_NAME\\lis-test\\WS2012R2\\lisa\\TestResults\\**\\*", name: 'perf_result'
                junit "$BUILD_NAME$BUILD_NUMBER$BRANCH_NAME\\lis-test\\WS2012R2\\lisa\\TestResults\\**\\*.xml"
            }
        }
    }
}

def parse_perf_data() {
    stage('parse_perf_data') {
        checkout scm
        dir("results") {
            unstash 'perf_result'
        }
        sh """
            #!/bin/bash
            scripts/comparison/parse_perf_data.py --logspath "results/$BUILD_NAME$BUILD_NUMBER$BRANCH_NAME/lis-test/WS2012R2/lisa/TestResults/$PERF_TEST"* \
                --testtype $PERF_TEST > "$WORKSPACE/perf_result" \
                --key $ioMode
          """
        archiveArtifacts "perf_result"
    }
}
